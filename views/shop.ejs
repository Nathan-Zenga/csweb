<%- include ('partials/header') -%>
    <div class="container">
        <%_ if (!products.length) { _%>
        <div style="padding: 50px 10px; text-align: center;">
            <h1>STOCKING UP<br>MERCH COMING SOON</h1>
        </div>
        <%_ } else { _%>
        <div style="text-align: right; font-weight: 600">
            <label for="fx-select" class="sr-only">Select Currency</label>
            <select id="fx-select" name="currency">
                <option value="<%= currency_code.toUpperCase() %>"><%- currency_name + (currency_symbol !== currency_code ? ` - ${currency_symbol}` : "") %></option>
                <%_ currencies.sort((a,b) => a.name.localeCompare(b.name)).forEach(curr => {
                    if (curr.code !== currency_code.toUpperCase() && rates[curr.code]) { _%>
                <option value="<%= curr.code %>"><%= curr.name + (curr.symbol ? ` - ${curr.symbol}` : "") %></option>
                <%_ }}) _%>
            </select>
            <i class="fas fa-chevron-down" id="dropdown-toggle"></i>
        </div>

        <div class="row">
            <%_ products.forEach(item => { var soldOut = item.stock_qty < 1; _%>
            <div class="product-thumb thumb content-container col-md-4 col-sm-6 float-left">
                <div class="content">
                    <p class="name" title="<%= item.name %>"><%= item.name %></p>
                    <div class="img-wrapper">
                        <div class="img" style="background-image: url('<%- item.image %>');<%= soldOut ? 'opacity:.5' : '' %>"></div>
                    </div>
                    <div class="text">
                        <p class="price" data-gbp-price="<%= (item.price / 100).toFixed(2) %>">
                            <span><%- (currency_symbol || currency_code).toUpperCase() %></span>
                            <span><%= converted_price(item.price).toFixed(2).replace(/\B(?<!\.\d*)(?=(\d{3})+(?!\d))/g, ","); %></span>
                        </p>
                        <div class="description">
                            <p><span><%= item.info %></span></p>
                            <a class="expand-toggler">
                                <span class="expand-label">See more</span>
                                <span class="collapse-label">See less</span>
                            </a>
                        </div>
                    </div>
                    <div class="cart-options">
                        <form class="add-to-cart" action="/shop/cart/add">
                            <input type="hidden" name="id" value="<%= item._id %>">
                            <input type="submit" style="<%= soldOut ? 'opacity:.5' : '' %>" data-value="<%= !soldOut ? 'ADD TO CART' : 'SOLD OUT' %>" value="<%= !soldOut ? 'ADD TO CART' : 'SOLD OUT' %>"<%= soldOut ? 'disabled' : '' %>>
                        </form>
                    </div>
                </div>
            </div>
            <%_ }) _%>
        </div>
        <%_ } _%>
    </div>
    <script>
        $(".add-to-cart").submit(function(e) {
            e.preventDefault();
            var $submitBtn = $(e.target).find("input[type=submit]");
            var initialVal = $submitBtn.data("value");
            var btnControl = new submitBtnController(this);
            $.post(this.action, $(this).serializeArray(), function(item_count) {
                $("#cart-icon").toggleClass("visible", item_count > 0);
                $("#cart-item-count").text(item_count);
            }).fail(function(err) {
                alert(err.responseText);
            }).always(function() {
                btnControl.finish();
                $submitBtn.val("ADDED!");
                setTimeout(function() { $submitBtn.val(initialVal) }, 2000);
            })
        });

        const prices = $(".product-thumb .price").map(function() { return parseFloat($(this).data("gbp-price")) });
        Object.freeze(prices);
        $("#fx-select").change(function() {
            $.post("/shop/fx", { currency_code: this.value }, function(res) {
                $(".product-thumb .price").fadeTo(0, .5);
                $("html, body").animate({ scrollTop: $(".product-thumb").length ? $(".product-thumb").eq(0).offset().top : undefined }, function() {
                    setTimeout(function() {
                        $(".product-thumb .price").fadeTo(500, 1).each(function(i, e) {
                            $(e).find("span").eq(0).text(res.symbol || res.currency_code.toUpperCase());
                            $(e).find("span").eq(1).text((prices[i] * res.rate).toFixed(2).replace(/\B(?<!\.\d*)(?=(\d{3})+(?!\d))/g, ","));
                        });
                    }, 200);
                });
            }).fail(function(err) {
                alert(err.responseText);
            })
        });

        $(".product-thumb .description .expand-toggler").click(function() {
            parseInt($(this).css("opacity")) == 1 && $(this).closest(".description").toggleClass("expanded");
        });

        $(window).on("load resize", function() {
            $(".product-thumb .description").removeClass("expanded").each(function(i, elm) {
                var p = $(elm).find("p");
                var span = $(elm).find("p span");
                var overflowing = span.width() > p.width();
                $(elm).find(".expand-toggler").fadeTo(0, Number(overflowing));
            });
        });
    </script>
<%- include ('partials/footer') -%>