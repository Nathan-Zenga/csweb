<%_ include partials/header _%>
    <!-- Display a payment form -->
    <div class="content-container #payment-form-container">
        <form id="payment-form">
            <div id="card-element"></div>
            <button id="submit">
                <div class="spinner hidden" id="spinner"></div>
                <span id="button-text">Pay</span>
            </button>
            <p id="card-error" role="alert"></p>
            <p class="result-message hidden">
                Payment succeeded, see the result in your
                <a href="" target="_blank">Stripe dashboard.</a> Refresh the page to pay again.
            </p>
        </form>
    </div>

	<script src="https://js.stripe.com/v3/"></script>
    <script defer>
        $(function() {
            var stripe = Stripe("<%= pk %>");
            var warning = "An updated version of your browser is required to make payments.\nPlease update your current browser or use a different one";
            // The items the customer wants to buy
            var purchase = { items: [{ id: "xl-tshirt", price: 2000 }] };

            $("#payment-form button").attr("disabled", true);
            if (!fetch || typeof fetch != "function") { alert(warning); throw warning }
            fetch("/shop/checkout/create-payment-intent", {
                method: "POST",
                headers: { "Content-Type": "application/json" },
                body: JSON.stringify(purchase)
            }).then(function (result) {
                return result.json();
            }).then(function (data) {
                var elements = stripe.elements();
                var card = elements.create("card", { style: {
                    base: { // input fields
                        color: "#32325d",
                        fontFamily: 'Arial, sans-serif',
                        fontSmoothing: "antialiased",
                        fontSize: "16px",
                        "::placeholder": {
                            color: "#32325d"
                        }
                    },
                    invalid: { // input fields (invalid)
                        fontFamily: 'Arial, sans-serif',
                        color: "#fa755a",
                        iconColor: "#fa755a"
                    }
                }});
                // Stripe injects an iframe into the DOM
                card.mount("#card-element");
                card.on("change", function (e) {
                    // Disable the Pay button if there are no card details in the Element
                    $("#payment-form button").attr("disabled", e.empty);
                    $("#card-error").prop("textContent", e.error ? e.error.message : "");
                });

                $("#payment-form").submit(function (e) {
                    e.preventDefault();
                    // Complete payment when the submit button is clicked
                    loading(true);
                    stripe.confirmCardPayment(data.clientSecret, { payment_method: { card }})
                        .then(function (result) {
                            // Show error to your customer
                            if (result.error) return showError(result.error.message);
                            // The payment succeeded!
                            orderComplete(result.paymentIntent.id);
                        });
                });
            });

            /* ------- UI helpers ------- */
            // Shows a success message when the payment is complete
            var orderComplete = function (paymentIntentId) {
                loading(false);
                $(".result-message a").removeClass("hidden").attr( "href", "https://dashboard.stripe.com/test/payments/" + paymentIntentId );
                $("#payment-form button").attr("disabled", true);
            };
            // Show the customer the error from Stripe if their card fails to charge
            var showError = function (errorMsgText) {
                loading(false);
                var errorMsg = $("#card-error").get(0);
                errorMsg.textContent = errorMsgText;
                setTimeout(function () { errorMsg.textContent = "" }, 4000);
            };

            // Show a spinner on payment submission
            var loading = function (isLoading) {
                // Disable the button and show a spinner
                $("#payment-form button").attr("disabled", isLoading);
                $("#spinner").toggleClass("hidden", !isLoading);
                $("#button-text").toggleClass("hidden", isLoading);
            };
        })
    </script>
    <%_ include partials/stripe-checkout-css _%>
<%_ include partials/footer _%>