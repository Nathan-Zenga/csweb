<%_ include partials/header _%>
    <!-- Display a payment form -->
    <div class="content-container #payment-form-container">
        <form id="payment-details-form" action="/shop/checkout/create-payment-intent">
            <div class="input-group row" style="display: block">
                <div class="col-sm-6">
                    <label for="firstname">FIRST NAME</label>
                    <input type="text" name="firstname" id="firstname" required>
                </div>
                <div class="col-sm-6">
                    <label for="lastname">LAST NAME</label>
                    <input type="text" name="lastname" id="lastname" required>
                </div>
            </div>
            <label for="email">EMAIL</label>
            <input type="email" name="email" id="email" required>
            <label for="address">ADDRESS</label>
            <input type="text" name="address" id="address" placeholder="Street / PO Box" required>
            <div class="input-group row" style="display: block">
                <div class="col-sm-6">
                    <label for="city">CITY</label>
                    <input type="text" name="city" id="city" required>
                </div>
                <div class="col-sm-6">
                    <label for="postcode">POST / ZIP CODE <span>(OPTIONAL)</span></label>
                    <input type="text" name="postcode" id="postcode" required>
                </div>
            </div>
            <input type="submit" value="CONTINUE TO PAYMENT">
        </form>

        <form id="payment-form" style="display: none;">
            <label for="card-element">ENTER PAYMENT DETAILS</label>
            <div id="card-element"></div>
            <button type="submit" id="submit-payment-btn" style="width: auto">
                <div class="spinner hidden" id="spinner"></div>
                <span id="button-text">PAY</span>
            </button>
            <p id="card-error" role="alert"></p>
            <p id="result-message" class="hidden">
                Payment succeeded, see the result in your
                <a href="" target="_blank">Stripe dashboard.</a> Refresh the page to pay again.
            </p>
        </form>
    </div>

    <style> form + form { padding-top: 0; margin-top: -2em; } </style>

    <script src="https://js.stripe.com/v3/"></script>
    <script>
        $("#payment-details-form").submit(function(e) {
            e.preventDefault();
            var stripe = Stripe("<%= pk %>");
            $.post(this.action, $(this).serializeArray(), function(data) {
                $("input", e.target).attr("disabled", true).filter(":submit").remove();
                $("#submit-payment-btn").attr("disabled", true).end().show(0, function() {
                    var elements = stripe.elements();
                    var card = elements.create("card", { style: {
                        base: { // input fields
                            color: "#32325d",
                            fontFamily: 'Arial, sans-serif',
                            fontSmoothing: "antialiased",
                            fontSize: "16px",
                            "::placeholder": {
                                color: "#32325d"
                            }
                        },
                        invalid: { // input fields (invalid)
                            fontFamily: 'Arial, sans-serif',
                            color: "#fa755a",
                            iconColor: "#fa755a"
                        }
                    }});
                    card.mount("#card-element"); // Stripe injects an iframe into the DOM
                    card.on("change", function(e) {
                        // Disable the Pay button if there are no card details in the Element
                        $("#submit-payment-btn").attr("disabled", e.empty);
                        $("#card-error").prop("textContent", e.error ? e.error.message : "");
                    });

                    $("#payment-form").submit(function(e) {
                        e.preventDefault();
                        // Complete payment when the submit button is clicked
                        loading(true);
                        $("#submit-payment-btn").attr("disabled", true);
                        stripe.confirmCardPayment(data.clientSecret, { payment_method: { card }})
                            .then(function(result) {
                                // Show error to your customer
                                if (result.error) return showError(result.error.message);
                                // The payment succeeded!
                                loading(false);
                                $("#result-message").removeClass("hidden").find("a").attr( "href", "https://dashboard.stripe.com/test/payments/" + result.paymentIntent.id );
                                $("#submit-payment-btn").attr("disabled", false);
                            });
                    });
                });
            });

            /* ------- UI helpers ------- */
            // Show the customer the error from Stripe if their card fails to charge
            var showError = function(errorMsgText) {
                loading(false);
                var errorMsg = $("#card-error").get(0);
                errorMsg.textContent = errorMsgText;
                setTimeout(function() { errorMsg.textContent = "" }, 4000);
            };

            // Show a spinner on payment submission
            var loading = function(isLoading) {
                // Disable the button and show a spinner
                $("#submit-payment-btn").attr("disabled", isLoading);
                $("#spinner").toggleClass("hidden", !isLoading);
                $("#button-text").toggleClass("hidden", isLoading);
            };
        })
    </script>
    <%_ include partials/stripe-checkout-css _%>
<%_ include partials/footer _%>