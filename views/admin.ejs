<%_ include partials/header _%>
    <div class="content-container" style="padding-top: 2em;">
        <ul class="nav nav-pills">
            <li class="active"><a data-toggle="pill" href="#articles">ARTICLES</a></li>
            <li><a data-toggle="pill" href="#discography">DISCOGRAPHY</a></li>
            <li><a data-toggle="pill" href="#artists">ARTISTS</a></li>
            <li><a data-toggle="pill" href="#edit-remove">EDIT / REMOVE</a></li>
        </ul>
        <div class="tab-content container">
            <div id="articles" class="tab-pane fade in active">
            <%_ include partials/admin/articles _%>
            </div>

            <div id="discography" class="tab-pane fade">
            <%_ include partials/admin/discography _%>
            </div>

            <div id="artists" class="tab-pane fade">
            <%_ include partials/admin/artists _%>
            </div>

            <div id="edit-remove" class="tab-pane fade">
            <%_ include partials/admin/edit-remove _%>
            </div>
        </div>
    </div>
    <script>
        var readAsDataURL = function(files, reader, submitInput) {
            $.each(files, function(i, file) {
                setTimeout(function() {
                    if (submitInput) submitInput.attr("disabled", true);
                    reader.readAsDataURL(file)
                }, i * 200);
            });
        };
        var showMessage = function(result, container) {
            var $msg = $('<div class="msg" style><div class="text">'+ result +'</div></div>');
            $msg.css("display", "none").appendTo(container).fadeIn().delay(2000).fadeOut(function(){ $(this).remove() });
        };

        var headline_images = [];
        $("#headline_images, #headline_images_change").change(function() {
            var files = this.files;
            headline_images = [];
            if (files.length) {
                var submitInput = $(this).closest("form").children("input:submit");
                var counter = 0;
                var reader = new FileReader();
                reader.onload = function() {
                    counter += 1;
                    headline_images.push(reader.result);
                    if (counter === files.length) submitInput.attr("disabled", false);
                };
                readAsDataURL(files, reader, submitInput);
            }
        });
        $("#articles form").submit(function(e) {
            e.preventDefault();
            var textbody = document.getElementById("textbody");
            textbody.value = textbody.value.replace(/(width|height|style)=\"(.*?)\"/gi, "").replace(/<iframe /gi, '<iframe style="height: 350px; width: 100%"');
            var data = { headline_images, textbody_media: textbody.value.match(/(.*?).(png|jpg|jpeg|gif)|<iframe(.*?)<\/iframe>/gi) || [] };
            $(this).serializeArray().forEach(function(field) {
                var name = field.name;
                data[name] = field.value;
            });
            $.post(this.action, data, function(result) {
                e.target.reset();
                showMessage(result, e.target);
            });
        });

        var artwork_file = "";
        $(":input[id*=all_platforms]").change(function() {
            $(this).closest("form").find(":input[id*=links]").val("").attr({ required: !this.checked, disabled: this.checked });
        });
        $(":input[id*=artwork_file], :input[id*=artwork_url]").change(function() {
            var id = this.id.includes("artwork_url") ? "artwork_file" : "artwork_url";
            var required = /edit|change/.test(this.id) ? false : !this.value;
            $(this).closest("form").find(":input[id*="+ id +"]").val("").attr({ required });
        });
        $("#artwork_file, #artwork_file_change").change(function() {
            var files = this.files;
            artwork_file = "";
            if (files.length) {
                var submitInput = $(this).closest("form").children("input:submit");
                var counter = 0;
                var reader = new FileReader();
                reader.onload = function() {
                    counter += 1;
                    artwork_file = reader.result;
                    if (counter === files.length) submitInput.attr("disabled", false);
                };
                readAsDataURL(files, reader, submitInput);
            }
        });
        $("#discography form").submit(function(e) {
            e.preventDefault();
            var data = {};
            $(this).serializeArray().forEach(function(field) {
                var name = field.name;
                data[name] = field.value;
            });

            var url_format = /^(?:http(s)?:\/\/)?[\w.-]+(?:\.[\w\.-]+)+[\w\-\._~:/?#[\]@!\$&'\(\)\*\+,;=.]+$/gim;
            if (data.links) data.links = data.links.match(url_format);
            if (artwork_file) data.artwork_file = artwork_file;

            $.post(this.action, data, function(result) {
                e.target.reset();
                showMessage(result, e.target);
            });
        });

        var profile_image = "";
        $("#profile_image, #profile_image_change").change(function() {
            var files = this.files;
            profile_image = "";
            if (files.length) {
                var submitInput = $(this).closest("form").children("input:submit");
                var counter = 0;
                var reader = new FileReader();
                reader.onload = function() {
                    counter += 1;
                    profile_image = reader.result;
                    if (counter === files.length) submitInput.attr("disabled", false);
                };
                readAsDataURL(files, reader, submitInput);
            }
        });
        $("#artists form").submit(function(e) {
            e.preventDefault();
            var data = { socials: {} };
            $(this).serializeArray().filter(function(field) { return field.value }).forEach(function(field) {
                var name = field.name;
                var social = name.replace("social_", "");
                !name.includes("social_") ? data[name] = field.value : data.socials[social] = field.value;
            });

            if (profile_image) data.profile_image = profile_image;

            $.post(this.action, data, function(result) {
                e.target.reset();
                showMessage(result, e.target);
            });
        });

        var action = "";
        $("#edit-remove select[name*=_id]").change(function(e) {
            $(this).closest("form").find(":input:not(:submit)").not(this).val("");
        });
        $("#edit-artist form").submit(function(e) {
            e.preventDefault();
            var data = { socials: {} };
            $(this).serializeArray().filter(function(field) { return field.value }).forEach(function(field) {
                var name = field.name;
                var social = name.replace("social_", "");
                !name.includes("social_") ? data[name] = field.value : data.socials[social] = field.value;
            });

            if (profile_image) data.profile_image_change = profile_image;

            $.post(this.action, data, function(result) {
                e.target.reset();
                showMessage(result, e.target);
            });
        });

        $("#edit-article form").submit(function(e) {
            e.preventDefault();
            var textbody = document.getElementById("textbody_edit");
            textbody.value = textbody.value.replace(/(width|height|style)=\"(.*?)\"/gi, "").replace(/<iframe /gi, '<iframe style="height: 350px; width: 100%"');
            var data = { headline_images_change: headline_images, textbody_media_change: textbody.value.match(/(.*?).(png|jpg|jpeg|gif)|<iframe(.*?)<\/iframe>/gi) || [] };
            $(this).serializeArray().forEach(function(field) {
                var name = field.name;
                data[name] = field.value;
            });
            $.post(this.action, data, function(result) {
                e.target.reset();
                showMessage(result, e.target);
            });
        });

        $("#edit-project form").submit(function(e) {
            e.preventDefault();
            var data = {};
            $(this).serializeArray().forEach(function(field) {
                var name = field.name;
                data[name] = field.value;
            });

            var url_format = /^(?:http(s)?:\/\/)?[\w.-]+(?:\.[\w\.-]+)+[\w\-\._~:/?#[\]@!\$&'\(\)\*\+,;=.]+$/gim;
            if (data.links_edit) data.links_edit = data.links_edit.match(url_format);
            if (artwork_file) data.artwork_file_change = artwork_file;
        });

        $("#remove form").submit(function(e) {
            e.preventDefault();
            var data = {};
            $(this).serializeArray().forEach(function(field) {
                var name = field.name;
                data[name] = field.value;
            });
            $.post(this.action, data, function(result) {
                e.target.reset();
                showMessage(result, e.target);
            });
        });
    </script>
<%_ include partials/footer _%>
